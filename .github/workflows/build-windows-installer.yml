name: Build and Test CLI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.11", "3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify installation
        run: |
          python main.py --version

      - name: Run tests
        run: |
          python -m unittest discover tests -v

      - name: Test CLI with fixture
        shell: bash
        run: |
          if [ -f "fixtures/SRX2507AFF046101/SRX2507AFF046101_20250731_153004.pdf" ]; then
            python main.py fixtures/SRX2507AFF046101/SRX2507AFF046101_20250731_153004.pdf
          else
            echo "Fixture PDF not found, skipping CLI test"
          fi

  build-executable:
    needs: test
    runs-on: windows-latest
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Validate required files
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          if (-not (Test-Path "main.py")) { throw "main.py not found" }
          if (-not (Test-Path "Templates/bon de commande V1.pdf")) {
            Write-Host "WARNING: Template not found, build will succeed but app may fail at runtime"
          }

      - name: Build CLI executable
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          python -m PyInstaller --noconfirm --clean --onefile --console --name "bdc-generator" `
            --add-data "Templates;Templates" `
            main.py

      - name: Verify executable
        shell: pwsh
        run: |
          $exePath = Join-Path $PWD "dist/bdc-generator.exe"
          if (-not (Test-Path $exePath)) { throw "Executable not found: $exePath" }
          & $exePath --version

      - name: Create release package
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $version = "1.0.0"
          $zipName = "BDC_Generator_CLI_v${version}_Windows.zip"
          $releaseDir = Join-Path $PWD "release"
          
          if (Test-Path $releaseDir) { Remove-Item -Recurse -Force $releaseDir }
          New-Item -ItemType Directory -Path $releaseDir | Out-Null
          
          Copy-Item -Path "dist/bdc-generator.exe" -Destination $releaseDir
          Copy-Item -Path "Templates" -Destination "$releaseDir/Templates" -Recurse
          Copy-Item -Path "README.md" -Destination $releaseDir
          Copy-Item -Path "requirements.txt" -Destination $releaseDir
          
          if (Test-Path $zipName) { Remove-Item $zipName -Force }
          Compress-Archive -Path "$releaseDir/*" -DestinationPath $zipName -Force
          
          Write-Host "Created: $zipName"
          $size = (Get-Item $zipName).Length / 1MB
          Write-Host "Size: $([math]::Round($size, 2)) MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: BDC-Generator-CLI-Windows
          path: BDC_Generator_CLI_v*_Windows.zip
          retention-days: 30
