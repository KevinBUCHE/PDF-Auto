name: Build BDC Generator

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install pyinstaller

      - name: Create required directories
        run: |
          if (-not (Test-Path "hooks")) { New-Item -ItemType Directory -Path "hooks" }
          if (-not (Test-Path "scripts")) { New-Item -ItemType Directory -Path "scripts" }
        shell: pwsh

      - name: Verify PySide6 installation
        run: |
          python -c "import PySide6; print('PySide6 version:', PySide6.__version__)"
          python -c "import PySide6, pathlib; p=pathlib.Path(PySide6.__file__).parent; print('PySide6 at:', p); qt_bin=p/'Qt'/'bin'; print('Qt bin:', qt_bin); print('Qt bin exists:', qt_bin.exists())"

      - name: Build with PyInstaller
        run: |
          pyinstaller --noconfirm --clean --onedir --windowed --name "BDC Generator" ^
            --add-data "Templates;Templates" ^
            --collect-all PySide6 ^
            --collect-all shiboken6 ^
            --collect-binaries PySide6 ^
            --collect-binaries shiboken6 ^
            --runtime-hook hooks/runtime_qt_path.py ^
            --hidden-import=PySide6.QtCore ^
            --hidden-import=PySide6.QtGui ^
            --hidden-import=PySide6.QtWidgets ^
            main.py
        shell: cmd

      - name: Debug - List dist contents before Qt copy
        shell: pwsh
        run: |
          Write-Host "=== Contents of dist/BDC Generator ==="
          Get-ChildItem -Path "dist/BDC Generator" -Recurse | Select-Object FullName | Format-Table -AutoSize
          Write-Host "`n=== Looking for Qt DLLs before copy ==="
          $qtDlls = Get-ChildItem -Path "dist/BDC Generator" -Recurse -Filter "Qt6*.dll" -ErrorAction SilentlyContinue
          if ($qtDlls) {
            $qtDlls | ForEach-Object { Write-Host "Found: $($_.FullName)" }
          } else {
            Write-Host "No Qt6 DLLs found yet (expected before Qt copy)"
          }

      - name: Copy Qt runtime DLLs
        run: |
          python scripts/copy_qt_runtime.py "dist/BDC Generator"
        shell: cmd

      - name: Debug - List dist contents after Qt copy
        shell: pwsh
        run: |
          Write-Host "`n=== Contents of dist/BDC Generator after Qt copy ==="
          Get-ChildItem -Path "dist/BDC Generator" -Recurse | Select-Object FullName | Format-Table -AutoSize

      - name: Verify all required DLLs are present
        shell: pwsh
        run: |
          $distDir = Join-Path $PWD "dist/BDC Generator"
          if (-not (Test-Path $distDir)) { 
            throw "dist folder not found: $distDir" 
          }
          
          Write-Host "`n=== Verifying required DLLs ==="
          
          # Qt DLLs
          $qtDlls = Get-ChildItem -Path $distDir -Recurse -Filter "Qt6*.dll" -ErrorAction SilentlyContinue
          if (-not $qtDlls) { 
            Write-Host "ERROR: No Qt6 DLLs found!"
            Write-Host "Expected location: $distDir\_internal\PySide6\Qt\bin\"
            throw "Missing required DLLs matching: Qt6*.dll" 
          }
          Write-Host "✓ Found Qt6 DLLs:"
          $qtDlls | ForEach-Object { Write-Host "  - $($_.Name) at $($_.FullName)" }
          
          # Shiboken DLLs
          $shibokenDlls = Get-ChildItem -Path $distDir -Recurse -Filter "shiboken6*.dll" -ErrorAction SilentlyContinue
          if (-not $shibokenDlls) { 
            throw "Missing required DLLs matching: shiboken6*.dll" 
          }
          Write-Host "`n✓ Found Shiboken6 DLLs:"
          $shibokenDlls | ForEach-Object { Write-Host "  - $($_.Name)" }
          
          # MSVC Runtime (optional, may be in system)
          $vcDlls = Get-ChildItem -Path $distDir -Recurse -Filter "vcruntime140*.dll" -ErrorAction SilentlyContinue
          if ($vcDlls) {
            Write-Host "`n✓ Found MSVC Runtime DLLs:"
            $vcDlls | ForEach-Object { Write-Host "  - $($_.Name)" }
          } else {
            Write-Host "`n⚠ MSVC Runtime DLLs not found in dist (may use system DLLs)"
          }

      - name: Create portable ZIP
        shell: pwsh
        run: |
          $version = "1.0.0"
          $zipName = "BDC_Generator_v${version}_Windows.zip"
          Compress-Archive -Path "dist/BDC Generator/*" -DestinationPath $zipName -Force
          Write-Host "Created: $zipName"
          $size = (Get-Item $zipName).Length / 1MB
          Write-Host "Size: $([math]::Round($size, 2)) MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: BDC-Generator-Windows
          path: BDC_Generator_v*.zip
          retention-days: 30
